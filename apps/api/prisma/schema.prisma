generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           Int                 @id @default(autoincrement())
  email        String              @unique
  passwordHash String
  name         String?
  createdAt    DateTime            @default(now())
  points       Int                 @default(0)
  comments     Comment[]           @relation("UserComments")
  performed    PointsTransaction[] @relation("PerformedActions")
  transactions PointsTransaction[] @relation("UserTransactions")
  projects     Project[]           @relation("OwnedProjects")
  memberships  ProjectMember[]     @relation("ProjectMemberships")
  versions     Version[]           @relation("VersionAuthors")
  badges       Badge[]             @relation("UserBadges")

  @@index([email])
}

model PointsTransaction {
  id          Int        @id @default(autoincrement())
  userId      Int
  actionType  ActionType
  points      Int
  createdAt   DateTime   @default(now())
  commentId   Int?
  line        Int?
  performerId Int?
  projectId   Int?
  versionId   Int?
  performer   User?      @relation("PerformedActions", fields: [performerId], references: [id])
  project     Project?   @relation("ProjectTransactions", fields: [projectId], references: [id])
  user        User       @relation("UserTransactions", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Badge {
  id          Int    @id @default(autoincrement())
  name        String @unique
  description String
  icon        String
  users       User[] @relation("UserBadges")
}

model Project {
  id           Int                 @id @default(autoincrement())
  ownerId      Int
  name         String
  description  String?
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @default(now())
  code         String?
  language     String
  comments     Comment[]           @relation("ProjectComments")
  transactions PointsTransaction[] @relation("ProjectTransactions")
  owner        User                @relation("OwnedProjects", fields: [ownerId], references: [id], onDelete: Cascade)
  members      ProjectMember[]
  versions     Version[]
}

model ProjectMember {
  id        Int              @id @default(autoincrement())
  projectId Int
  userId    Int
  status    InvitationStatus @default(PENDING)
  project   Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User             @relation("ProjectMemberships", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([userId])
  @@index([projectId])
}

model Version {
  id               Int       @id @default(autoincrement())
  projectId        Int
  language         String
  code             String?
  authorId         Int
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @default(now())
  resolvedComments Comment[] @relation("ResolvedComments")
  comments         Comment[] @relation("VersionComments")
  author           User      @relation("VersionAuthors", fields: [authorId], references: [id])
  project          Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([authorId])
}

model Comment {
  id                Int       @id @default(autoincrement())
  versionId         Int?
  line              Int
  authorId          Int
  parentId          Int?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @default(now())
  content           String?
  endLine           Int?
  originalCode      String?
  projectId         Int
  resolvedVersionId Int?
  yAnchor           String?
  author            User      @relation("UserComments", fields: [authorId], references: [id], onDelete: Cascade)
  parent            Comment?  @relation("CommentThread", fields: [parentId], references: [id], onDelete: Cascade)
  children          Comment[] @relation("CommentThread")
  project           Project   @relation("ProjectComments", fields: [projectId], references: [id], onDelete: Cascade)
  resolvedIn        Version?  @relation("ResolvedComments", fields: [resolvedVersionId], references: [id])
  version           Version?  @relation("VersionComments", fields: [versionId], references: [id])

  @@index([projectId])
  @@index([versionId])
  @@index([authorId])
  @@index([parentId])
  @@index([line])
}

enum Language {
  JAVASCRIPT
  PYTHON
  JAVA
}

enum ActionType {
  COMMENT_CREATED
  COMMENT_RESOLVED
  INVITATION_SENT
  INVITATION_ACCEPTED
  INVITATION_DECLINED
}

enum InvitationStatus {
  PENDING
  ACCEPTED
}
